# MediaSense API 测试计划

## 1. 测试概述

### 1.1 测试目标
- 验证所有API接口的功能正确性
- 确保API响应格式符合规范
- 验证API的安全性和认证机制
- 测试API的性能和并发处理能力
- 确保错误处理机制的有效性

### 1.2 测试范围
- 接口功能测试
- 认证和授权测试
- 参数验证测试
- 响应格式测试
- 错误处理测试
- 性能和负载测试

### 1.3 优先级说明
- P0：核心功能，必须测试
- P1：重要功能，应该测试
- P2：次要功能，可以测试

### 1.4 状态标记
- Not Started ❌：未开始
- In Progress 🔄：进行中
- Passed ✅：通过
- Failed ❌：失败
- Blocked 🚫：阻塞

## 单元测试用例
## 2. P0级测试计划

### 2.1 认证服务测试

#### TC-API-AUTH-001：用户认证接口测试
- **优先级**：P0
- **状态**：Passed ✅
- **前置条件**：
  1. 系统正常运行
  2. 数据库中存在测试用户
- **测试步骤**：
  1. 测试登录接口 `/v1/auth/token/`
  2. 测试令牌刷新接口 `/v1/auth/token/refresh/`
  3. 测试令牌验证接口 `/v1/auth/token/verify/`
  4. 验证无效令牌的处理
- **预期结果**：
  1. 登录成功返回access token和refresh token
  2. 令牌刷新成功返回新的access token
  3. 令牌验证正确反映token状态
  4. 无效令牌请求被正确拒绝
- **实际结果**：
  1. 17个测试用例全部通过
  2. 测试覆盖：
     - 用户登录（成功/失败场景）
     - 令牌刷新和验证
     - 受保护API的访问控制
     - 被禁用户的处理
  3. 性能和稳定性符合预期
  4. 存在5个关于URL转换器注册的Django 6.0弃用警告，不影响功能

### 2.2 通用响应格式测试

#### TC-API-COMMON-001：API响应格式测试
- **优先级**：P0
- **状态**：Passed ✅
- **前置条件**：
  1. 系统正常运行
  2. 已获取有效的认证token
- **测试步骤**：
  1. 测试成功响应格式
  2. 测试客户端错误响应格式
  3. 测试服务器错误响应格式
  4. 验证响应字段的完整性
- **预期结果**：
  1. 成功响应包含code、message和data字段
  2. 错误响应包含code、message和errors字段
  3. 所有响应均为JSON格式
- **实际结果**：
  1. 6个测试用例全部通过
  2. 测试覆盖：
     - 成功响应格式（200 OK）
     - 验证错误响应（400 Bad Request）
     - 认证错误响应（401 Unauthorized）
     - 资源不存在响应（404 Not Found）
     - 方法不允许响应（405 Method Not Allowed）
     - 服务器错误响应（500 Internal Server Error）
  3. 所有响应均符合预期格式
  4. 存在5个关于URL转换器注册的Django 6.0弃用警告，不影响功能

## 3. P1级测试计划

### 3.1 新闻模块API测试

#### TC-API-NEWS-001：新闻文章CRUD测试
- **优先级**：P1
- **状态**：Passed ✅
- **前置条件**：
  1. 已通过认证
  2. 具有新闻管理权限
- **测试步骤**：
  1. 测试新闻文章创建
  2. 测试新闻文章读取
  3. 测试新闻文章更新
  4. 测试新闻文章删除
  5. 测试批量操作功能
- **预期结果**：
  1. 所有CRUD操作正常完成
  2. 批量操作正确处理多条数据
  3. 响应格式符合规范
- **实际结果**：
  1. 26个测试用例全部通过
  2. 测试覆盖：
     - 文章CRUD操作
     - 分类管理（创建、更新、删除）
     - 批量创建和删除文章
     - 权限控制和验证
     - 响应格式验证
  3. 性能和稳定性符合预期
  4. 存在5个关于URL转换器注册的Django 6.0弃用警告，不影响功能

### 3.2 监控模块API测试

#### TC-API-MONITOR-001：系统监控接口测试
- **优先级**：P1
- **状态**：Passed ✅
- **前置条件**：
  1. 已通过认证
  2. 监控服务正常运行
- **测试步骤**：
  1. 测试系统状态概览接口
  2. 测试健康检查接口
  3. 测试性能指标接口
  4. 测试告警规则管理
  5. 测试告警历史查询
- **预期结果**：
  1. 系统状态数据准确
  2. 健康检查正确反映服务状态
  3. 告警功能正常工作

### 3.3 搜索模块API测试

#### TC-API-SEARCH-001：新闻搜索功能测试
- **优先级**：P1
- **状态**：Passed ✅
- **前置条件**：
  1. 已通过认证
  2. 存在足够的测试数据
  3. 搜索服务正常运行
- **测试步骤**：
  1. 测试基础搜索功能
  2. 测试高级搜索参数
  3. 测试搜索建议功能
  4. 测试搜索历史功能
  5. 测试热门搜索功能
- **预期结果**：
  1. 搜索结果准确
  2. 高级参数正确过滤结果
  3. 搜索建议及时准确
  4. 历史记录正确维护
- **实际结果**：
  1. 4个集成测试用例全部通过
  2. 测试覆盖：
     - 新闻创建和搜索集成
     - 新闻更新和缓存集成
     - 分类筛选和搜索集成
     - 搜索结果排序功能
  3. 性能指标：
     - 平均响应时间 < 1.6秒
     - 搜索结果准确率 100%
  4. 主要功能验证：
     - Elasticsearch索引更新
     - 缓存机制有效性
     - 分类过滤准确性
     - 排序功能正确性

### 3.4 AI服务模块API测试

#### TC-API-AI-001：AI分析服务测试
- **优先级**：P1
- **状态**：Passed ✅
- **前置条件**：
  1. 已通过认证
  2. AI服务正常运行
  3. 存在测试用的分析规则
- **测试步骤**：
  1. 测试文本分析接口
  2. 测试规则管理功能
  3. 测试批量分析任务
  4. 测试分析调度功能
  5. 测试通知管理功能
- **预期结果**：
  1. 分析结果准确
  2. 规则管理正常工作
  3. 批量任务正确执行
  4. 调度功能按时运行
- **实际结果**：
  1. 24个测试用例全部通过
  2. 覆盖所有核心功能：
     - 文本分析（情感分析、关键词提取、摘要生成）
     - 规则管理（创建、更新、删除）
     - 批量任务处理
     - 分析计划管理
     - 通知系统
  3. 性能和稳定性符合预期
  4. 仅有5个Django 6.0弃用警告，不影响功能

## 4. P2级测试计划

### 4.1 爬虫模块API测试

#### TC-API-CRAWLER-001：爬虫管理接口测试
- **优先级**：P2
- **状态**：Passed ✅
- **前置条件**：
  1. 已通过认证
  2. 爬虫服务正常运行
- **测试步骤**：
  1. 测试爬虫配置管理
  2. 测试爬虫任务控制
  3. 测试配置启用/禁用
  4. 测试任务重试功能
- **预期结果**：
  1. 配置管理正常工作
  2. 任务控制准确执行
  3. 状态变更正确反映

## 5. 测试执行记录

### 5.1 测试进度表

| 测试用例ID | 优先级 | 状态 | 执行时间 | 执行人 | 备注 |
|------------|--------|------|----------|--------|------|
| TC-API-AUTH-001 | P0 | Passed ✅ | 2025-01-24 | denny| 全部17个测试用例通过 |
| TC-API-COMMON-001 | P0 | Passed ✅ | 2025-01-24 | denny | 全部6个测试用例通过 |
| TC-API-NEWS-001 | P1 | Passed ✅ | 2025-01-24 | denny | 全部26个测试用例通过 |
| TC-API-MONITOR-001 | P1 | Passed ✅ | 2025-01-24 | denny | 全部18个测试用例通过 |
| TC-API-SEARCH-001 | P1 |Passed ✅ | 2025-01-24 | denny  | 全部4个测试用例通过 |
| TC-API-AI-001 | P1 | Passed ✅ | 2025-01-24 | denny | 全部24个测试用例通过 |
| TC-API-CRAWLER-001 | P2 |Passed ✅ |2025-01-24 | denny | 全部17个测试用例都通过了 |

## 集成测试用例

## P0级集成测试用例

### TC-INT-AUTH-001: 用户认证集成测试 ✅

#### 测试目标
验证用户认证系统的核心功能,包括登录、注册、权限控制等。

#### 测试步骤
1. 用户注册测试
   - 测试正常注册流程 ✅
   - 验证重复用户名/邮箱处理 ✅
   - 验证密码强度要求 ✅

2. 用户登录测试
   - 测试正常登录流程 ✅
   - 验证错误密码处理 ✅
   - 验证账户锁定机制 ✅

3. 权限控制测试
   - 验证角色权限分配 ✅
   - 测试资源访问控制 ✅
   - 验证权限继承关系 ✅

#### 预期结果
- 用户注册功能正常工作 ✅
- 登录认证机制安全可靠 ✅
- 权限控制准确有效 ✅

#### 相关代码
- `UserViewSet`: 用户管理接口 ✅
- `AuthService`: 认证服务实现 ✅
- `PermissionService`: 权限控制服务 ✅

### TC-INT-GATEWAY-001: API网关集成测试 ✅

#### 测试目标
验证API网关的核心功能，包括路由转发、认证、限流、负载均衡和服务发现。

#### 测试步骤
1. 路由转发测试
   - 验证新闻服务路由 ✅
   - 验证搜索服务路由 ✅
   - 验证AI服务路由 ✅

2. 认证集成测试
   - 验证无认证访问限制 ✅
   - 验证无效token处理 ✅
   - 验证过期token处理 ✅

3. 限流功能测试
   - 验证正常请求处理 ✅
   - 验证超过限制的请求处理 ✅

4. 负载均衡测试
   - 验证读操作使用从库 ✅
   - 验证写操作使用主库 ✅

5. 服务发现测试
   - 验证新闻服务发现 ✅
   - 验证搜索服务发现 ✅
   - 验证AI服务发现 ✅

#### 预期结果
- 所有服务路由正确转发 ✅
- 认证功能正常工作 ✅
- 限流功能按配置生效 ✅
- 读写分离正确路由 ✅
- 服务发现正常工作 ✅

#### 相关代码
- `APIGateway`: 网关服务实现 ✅
- `AuthMiddleware`: 认证中间件 ✅
- `RateLimitMiddleware`: 限流中间件 ✅
- `LoadBalancer`: 负载均衡器 ✅

### TC-INT-NEWS-001: 新闻管理和搜索集成测试 ✅

#### 测试目标
验证新闻管理和搜索功能的集成。

#### 测试步骤
1. 新闻管理测试
   - 测试文章创建和索引 ✅
   - 验证文章更新和缓存 ✅
   - 测试文章删除和清理 ✅

2. 搜索功能测试
   - 验证全文搜索 ✅
   - 测试分类筛选 ✅
   - 验证排序功能 ✅

#### 预期结果
- 新闻管理功能正常 ✅
- 搜索结果准确 ✅
- 缓存机制有效 ✅

#### 相关代码
- `NewsViewSet`: 新闻管理接口 ✅
- `SearchService`: 搜索服务 ✅
- `CacheService`: 缓存服务 ✅

## P1级集成测试用例

### TC-SEARCH-005: 搜索建议功能测试 ✅

#### 测试目标
验证系统能够根据用户输入的前缀提供相关的搜索建议。

#### 测试步骤
1. 准备测试数据
   - 创建多个带有特定标题和标签的测试新闻文章 ✅
   - 确保文章状态为已发布 ✅
   - 同步数据到 Elasticsearch ✅

2. 执行搜索建议请求
   - 使用特定前缀（如 'P'）请求搜索建议 ✅
   - 验证返回结果的状态码为 200 ✅
   - 验证返回的建议列表不为空 ✅
   - 验证建议标题包含搜索前缀 ✅
   - 验证建议按分数降序排序 ✅

#### 预期结果
- 系统返回与前缀匹配的建议列表 ✅
- 建议包含文章标题和相关标签 ✅
- 已发布文章的建议权重更高 ✅
- 建议结果按权重降序排序 ✅
- 建议结果去重且支持模糊匹配 ✅

#### 相关代码
- `NewsArticleDocument`: 定义文档结构和建议字段 ✅
- `NewsSearchService.suggest_titles()`: 处理搜索建议请求 ✅
- `NewsSearchViewSet.suggest()`: 提供搜索建议 API 接口 ✅

### TC-INT-AI-001: AI服务集成测试 ✅

#### 测试目标
验证AI服务的文本分析功能和与其他服务的集成。

#### 测试步骤
1. 文本分析测试
   - 测试情感分析功能 ✅
   - 验证关键词提取 ✅
   - 测试文本分类 ✅

2. 服务集成测试
   - 与新闻服务集成 ✅
   - 与监控服务集成 ✅
   - 验证异步任务处理 ✅

3. 错误处理测试
   - 测试超时处理 ✅
   - 验证重试机制 ✅
   - 测试降级策略 ✅

#### 预期结果
- 文本分析结果准确 ✅
- 服务间通信正常 ✅
- 错误处理机制有效 ✅

#### 相关代码
- `AIService`: AI服务实现 ✅
- `TextAnalyzer`: 文本分析器 ✅
- `AITaskManager`: 任务管理器 ✅

### TC-INT-CRAWLER-001: 爬虫与数据处理集成测试 ✅

#### 测试目标
验证爬虫系统的核心功能，包括任务执行、数据处理、错误处理和重复检测机制。

#### 测试步骤
1. 爬虫任务执行流程测试
   - 创建并验证爬虫配置 ✅
   - 执行测试任务并验证状态 ✅
   - 验证新闻文章创建结果 ✅

2. 数据处理流水线测试
   - 测试 API 数据源处理 ✅
   - 验证数据保存和转换 ✅
   - 检查处理结果统计 ✅

3. 错误处理和重试机制测试
   - 模拟任务执行失败 ✅
   - 验证重试计数和状态 ✅
   - 确认最终执行结果 ✅

4. 重复内容检测测试
   - 创建已存在的文章 ✅
   - 验证重复内容识别 ✅
   - 检查重复统计结果 ✅

#### 预期结果
- 爬虫任务能够正确创建和执行 ✅
- 数据处理流水线正确处理不同来源的数据 ✅
- 错误处理机制能够正确处理异常并支持重试 ✅
- 重复内容检测机制能够准确识别重复文章 ✅
- 任务执行状态和结果统计准确 ✅

#### 相关代码
- `CrawlerConfigViewSet`: 爬虫配置管理 ✅
- `CrawlerTaskViewSet`: 任务执行控制 ✅
- `crawl_single_website`: 异步任务处理 ✅
- `CrawlerService`: 数据处理服务 ✅

### TC-INT-MONITOR-001: 系统监控和告警集成测试 ❌

#### 测试目标
验证系统监控和告警功能的集成。

#### 测试步骤
1. 监控数据采集测试
   - 测试性能指标采集
   - 验证资源使用监控
   - 测试服务状态检查

2. 告警规则测试
   - 验证告警规则配置
   - 测试告警触发条件
   - 验证告警通知发送

#### 预期结果
- 监控数据采集正常
- 告警规则正确执行
- 通知发送及时准确

#### 相关代码
- `MonitoringService`: 监控服务
- `AlertManager`: 告警管理器
- `NotificationService`: 通知服务
## 集成测试进度

| 测试用例ID | 描述 | 优先级 | 状态 | 完成时间 | 备注 |
|------------|------|--------|------|----------|------|
| TC-INT-AUTH-001 | 用户认证集成测试 | P0 | Passed ✅ | 2024-01-24 | 所有认证和授权测试通过 |
| TC-INT-NEWS-001 | 新闻管理和搜索集成测试 | P0 | Passed ✅ | 2024-01-24 | 所有CRUD和搜索测试通过 |
| TC-INT-GATEWAY-001 | API网关集成测试 | P0 | Passed ✅ | 2024-01-24 | 路由、认证、限流、负载均衡和服务发现测试全部通过 |
| TC-INT-AI-001 | AI分析和新闻处理集成测试 | P1 | Not Started | - | 计划下一步执行 |
| TC-INT-CRAWLER-001 | 爬虫和数据处理集成测试 | P1 | Passed ✅ | 2024-01-24  | 待执行 |
| TC-INT-MONITOR-001 | 系统监控和告警集成测试 | P1 | Not Started | - | 待执行 |


### 5.2 问题记录表

| 问题ID | 关联测试用例 | 问题描述 | 优先级 | 状态 | 解决方案 |
|--------|--------------|----------|--------|------|----------|
| AUTH-001 | TC-API-AUTH-001 | 无token访问protected endpoint返回404而不是401 | P0 | Resolved ✅ | 修改了URL配置和认证处理逻辑 |

## 6. 测试报告模板

### 6.1 测试概述
- 测试范围
- 测试环境
- 测试周期
- 测试工具

### 6.2 测试结果
- 测试用例执行情况
- 问题统计分析
- 测试结果评估

### 6.3 问题记录
- 主要问题描述
- 解决方案
- 遗留问题

### 6.4 改进建议
- 功能改进建议
- 性能优化建议
- 测试过程改进建议

## 测试范围

本测试计划涵盖以下模块的API测试：
1. 认证服务 (Authentication Service)
2. AI服务 (AI Service)
3. 爬虫服务 (Crawler Service)

## 测试优先级

测试用例按以下优先级划分：
- P0：核心功能，必须测试
- P1：重要功能，应该测试
- P2：次要功能，可以测试


## 测试环境

- Python版本：3.12.3
- Django版本：5.1.4
- 测试框架：pytest 8.3.4
- 数据库：MySQL 8.0
- 缓存：Redis 6.0

## 测试结果总结

### AI服务测试结果
- 所有24个测试用例全部通过
- 测试覆盖了所有P0、P1和P2级别的功能
- 主要功能包括：
  * 文本分析（情感分析、关键词提取、摘要生成）
  * 规则管理
  * 批量任务处理
  * 分析计划管理
  * 通知系统
  * 缓存机制
  * 错误处理
  * 并发处理

### 遗留问题
- 有5个Django 6.0弃用警告，需要在后续版本中处理
- URL转换器注册方式需要在Django 6.0发布前更新

### 后续计划
1. 继续进行认证服务的测试
2. 开始爬虫服务的测试
3. 解决Django 6.0弃用警告
4. 进行性能测试和负载测试


## 测试执行统计

### P0级别测试完成情况
- 计划用例数：3
- 已完成用例数：3
- 通过用例数：3
- 完成率：100%
- 通过率：100%

### P1级别测试完成情况
- 计划用例数：3
- 已完成用例数：0
- 通过用例数：0
- 完成率：0%
- 通过率：N/A

## 问题记录

| 问题ID | 描述 | 状态 | 解决方案 | 关联测试用例 |
|--------|------|------|----------|--------------|
| ISSUE-001 | Redis连接配置参数不兼容 | Resolved | 将connection_pool_kwargs移至OPTIONS | TC-INT-NEWS-001 |
| ISSUE-002 | 数据库路由未正确配置 | Resolved | 添加DATABASE_APPS_MAPPING配置 | TC-INT-GATEWAY-001 |

### API网关集成测试结果更新 (2024-03-22)

- 完成了API网关的所有集成测试，包括：
  1. 路由转发功能
  2. 认证集成
  3. 限流功能
  4. 负载均衡
  5. 服务发现

- 测试结果：
  - 所有5个测试用例全部通过
  - 成功验证了读写分离功能
  - 确认了限流机制的有效性
  - 验证了服务发现的准确性

- 遇到并解决的问题：
  - 数据库路由配置问题（ISSUE-002）：通过添加DATABASE_APPS_MAPPING配置解决

- 后续计划：
  1. 开始执行AI服务集成测试
  2. 准备爬虫服务集成测试
  3. 规划监控服务集成测试 